version: '3'

services:

  rabbit1:
    container_name: rockiot_rabbitmq
    build:
      context: ./docker/rabbit
    hostname: rabbit1
    volumes:
      - ./docker/rabbit/rabbitmq_enabled_plugins:/etc/rabbitmq/enabled_plugins
      - $HOME/docker/rabbitmq/data:/var/lib/rabbitmq/mnesia/
      - $HOME/docker/certificates/:/etc/ssl/certs/
    networks:
      - app-tier
    ports:
      - "5671:5671"
      - "5672:5672"
      - "1883:1883"
      - "8883:8883"
      - "15672:15672"
      - "15692:15692"

  rockiot: &rockiotfunction
    container_name: rockiot_app
    build:
      context: rockiot
      dockerfile: ./Dockerfile
    command: >
      sh -c "/wait.sh && /start.sh"
    depends_on:
      - rabbit1
    networks:
      - app-tier
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - rockiot-data:/rockiot-data
    env_file:
      - db.env
      - common.env
      - django.env
    ports:
      - 8000:8000
    environment:
      - BROKER_EXCHANGE=amq.topic
      - WAIT_HOSTS=rabbit1:8883,rabbit1:15672

  rockiotworker:
    <<: *rockiotfunction
    container_name: rockiot_app_worker
    command: >
      sh -c "/wait.sh && celery -A tasks.celery worker -Q normal -n normal@%h -l info -c 2 -E"
    ports: [ ]
    depends_on:
      - rabbit1
      - rockiot
    environment:
      - DEBUG=False
      - BROKER_EXCHANGE=amq.topic
      - WAIT_HOSTS=rabbit1:8883,rabbit1:15672,rockiot:8000

  rockiotbeat:
    <<: *rockiotfunction
    container_name: rockiot_app_beat
    command: >
      sh -c "/wait.sh && celery -A tasks.celery beat -l info -S django"
    ports: [ ]
    depends_on:
      - rabbit1
      - rockiot
    environment:
      - DEBUG=False
      - BROKER_EXCHANGE=amq.topic
      - WAIT_HOSTS=rabbit1:8883,rabbit1:15672,rockiot:8000

  rockiotlistener:
    <<: *rockiotfunction
    container_name: rockiot_app_listener
    command: >
      sh -c "/wait.sh && python manage.py listen_amqp_actions"
    ports: [ ]
    depends_on:
      - rabbit1
      - rockiot
    environment:
      - BROKER_EXCHANGE=amq.topic
      - WAIT_HOSTS=rabbit1:8883,rabbit1:15672,rockiot:8000

  rockiot_ingest:
    build: rockiot_ingest
    env_file:
      - db.env
      - common.env
    environment:
      - BROKER_USER=amqpingest
      - BROKER_PASS=amqpingest_pass
      - BROKER_QUEUE=mq2_amqp
      - WAIT_HOSTS=rabbit1:8883,rockiot:8000
    depends_on:
      - rabbit1
      - rockiot
    networks:
      - app-tier

  nodeexporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    restart: unless-stopped
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.rootfs=/rootfs'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    expose:
      - "9100:9100"
    networks:
      - app-tier

networks:
  app-tier:
    driver: bridge

volumes:
  rockiot-data:
